##### start of the Pipeline #####
## The input is the fastq files from the sequencer ##
## the goal is to concatenate files together, trim the adapter sequences, and align with BWA 

##### Step 1: concatenate fastq files so each sample has 1 forward and 1 reverse read #####
# SeqID.txt contains the unique identifier at teh beginning of each file name, one to a line

# start by combining 001 to 00X for each lane independently
# run these lines in the directory with 
while IFS= read -r line; do for x in 1 2; do cat "$line"_L00"$x"_R1_00*.fastq > "$line"_L00"$x"_R1_comb.fastq; done; done < SeqID.txt
while IFS= read -r line; do for x in 1 2; do cat "$line"_L00"$x"_R2_00*.fastq > "$line"_L00"$x"_R2_comb.fastq; done; done < SeqID.txt
# now join the L001 and L002 together
while IFS= read -r line; do cat "$line"_L001_R1_comb.fastq "$line"_L002_R1_comb.fastq > "$line"_R1_comb.fastq; done < SeqID.txt
while IFS= read -r line; do cat "$line"_L001_R2_comb.fastq "$line"_L002_R2_comb.fastq > "$line"_R2_comb.fastq; done < SeqID.txt
# and remove the intermediate files for space
rm *_L00*_R*_comb.fastq
# bgzip everyting for space
cd /mnt/research/RadishSequence/ArabidopsisSequence/fastq
for f in *.fastq; do ~/Apps/bgzip "$f";done

##### Step 2: Run FastQC to check sample quality #####
ssh -X buysseso@hpcc.msu.edu
ssh dev-amd20-v100
module load FastQC
fastqc /mnt/research/RadishSequence/ArabidopsisSequence/bamFiles/BIS20.rg.bam
# the results are written to the bamFiles folder. Do this in a loop for the rest.
while IFS= read -r line; do fastqc /mnt/research/RadishSequence/ArabidopsisSequence/fastq/"$line"_R1_comb.fastq & done

#### Step 3: Trim Adapter Sequences #####
### 2A do this with trimmomatic ###

#!/bin/bash
##Job settings for without -t settings
#SBATCH --job-name=test_trimmomatic
#SBATCH -e test_trimmomatic.err
#SBATCH -o test_trimmomatic.out

##Job Resources
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=1
#SBATCH --mem-per-cpu=6gb
#SBATCH -t 23:59:00
#SBATCH --mail-user=buysseso@msu.edu
#SBATCH --mail-type=FAIL,BEGIN,END

cd $SLURM_SUBMIT_DIR

###############
## VARIABLES ##
###############

module load Java/11.0.2 \
Trimmomatic/0.39-Java-11

while IFS= read -r line; do java -jar $EBROOTTRIMMOMATIC/trimmomatic-0.39.jar \
 PE \
-phred33 \
-basein /mnt/research/RadishSequence/ArabidopsisSequence/fastq/"$line"_R1_comb.fastq \
-baseout /mnt/research/RadishSequence/ArabidopsisSequence/fastq/trimmed/"$line".fastq \
ILLUMINACLIP:/mnt/research/RadishSequence/ArabidopsisSequence/fastq/Nextera_adapter.fa:2:30:10 \
LEADING:3 \
TRAILING:3 \
SLIDINGWINDOW:4:15 \
MINLEN:30; done < /mnt/research/RadishSequence/ArabidopsisSequence/fastq/SeqID.txt

### 2B: do this with Trim Galore ###
# this trims and then runs fastq again on the trimmed file all at once!
while IFS= read -r line; do trim_galore \
--nextera \
--paired \
--fastqc \
-o TG_trimmed "$line"_R1_comb.fastq "$line"_R2_comb.fastq; done < /mnt/research/RadishSequence/ArabidopsisSequence/fastq/SeqID.txt 
