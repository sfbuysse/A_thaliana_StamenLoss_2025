########## Filter Variants ##########

##### Load Modules ######
module purge
module load GCC/7.3.0-2.30  OpenMPI/3.1.1
module load tabix
module load VCFtools/0.1.15-Perl-5.28.0
module load GATK/4.1.4.1-Python-3.6.6

##### Step 1: Filtered All Sites #####
## The first filtered file we make will be for the population genetics statistics, so we will filter it less stringently
## from following the pixy protocol https://pixy.readthedocs.io/en/latest/guide/pixy_guide.html

#!/bin/bash
##Job settings for without -t settings
#SBATCH --job-name=filter_vcf
#SBATCH -e filter_vcf.err
#SBATCH --nodes=1
#SBATCH --ntasks=4
#SBATCH --cpus-per-task=4
#SBATCH --mem-per-cpu=24gb
#SBATCH -t 10:59:00
#SBATCH --mail-user=buysseso@msu.edu
#SBATCH --mail-type=FAIL,BEGIN,END
cd /mnt/scratch/buysseso/GVCF
module purge
module load GCC/7.3.0-2.30  OpenMPI/3.1.1
module load tabix
module load bcftools/1.9.64
module load VCFtools/0.1.15-Perl-5.28.0

# invariant sites
vcftools --gzvcf allsites.raw.g.vcf.gz \
--max-maf 0 \
--min-meanDP 3 \
--minQ 15 \
--remove-indels \
--max-missing 0.75 \
--max-alleles 2 \
--remove-indv COC7_TCCTGAGC-TATCCTCT \
--recode --stdout | ~/Apps/bgzip -c > invariant.vcf.gz
# kept 97833193 sites

# create a filtered VCF containing only variant sites
# keep these as only biallelic
vcftools --gzvcf allsites.raw.g.vcf.gz \
--mac 1 \
--min-meanDP 3 \
--minQ 15 \
--remove-indels \
--max-missing 0.75 \
--min-alleles 2 \
--max-alleles 2 \
--remove-indv COC7_TCCTGAGC-TATCCTCT \
--recode --stdout | ~/Apps/bgzip -c > biallelic.variant.vcf.gz
# kept 3230225 sites

# index both vcfs using tabix
tabix invariant.vcf.gz
tabix biallelic.variant.vcf.gz

# combine the two VCFs using bcftools concat
~/Apps/bcftools concat \
--allow-overlaps \
invariant.vcf.gz biallelic.variant.vcf.gz \
-O z -o all.filtered.vcf.gz

scontrol show job $SLURM_JOB_ID

$ grep -v "^#" all.filtered.vcf|wc -l

#Submitted batch job 34434100

##### Step 2: Filtered Variant Sites #####
## we then need a more strictly filtered file of ONLY the variant sites to use for the GWAS
vcftools --gzvcf allsites.raw.g.vcf.gz \
--max-maf 0.05 \
--min-meanDP 5 \
--minQ 30 \
--remove-indels \
--max-missing 0.75 \
--min-alleles 2 \
--max-alleles 2 \
--remove-indv COC7_TCCTGAGC-TATCCTCT \
--recode --stdout | ~/Apps/bgzip -c > allSNPs.noIndelsMafp05MaxMissp75BiallelicQ30Dp5.vcf.gz

## After filtering, kept 61 out of 62 Individuals
## Outputting VCF file...
## After filtering, kept **1398791** out of a possible 116743295 Sites
## Run Time = 798.00 seconds

